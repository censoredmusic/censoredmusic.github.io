<script>
// ================= SECRET KEYPAD STATE (MUST BE FIRST) =================
let secretActive = false;
let keySequence = "";
let typedKeys = "";
const expectedCode = "150677";

// ================= SONGS & PLAYLISTS =================
const playlists = {
  "Raghib's Playlist": [
    {
      name:"Daylight (Drake)",
      src:"music/daylight_drake.mp3",
      cover:"covers/daylight.jpg",
      lyrics:[
        {time:0,text:"Treat all my exes like Jehovah's Witnesses"},
        {time:4,text:"Free all the dogs and fuck all the witnesses"}
      ]
    },
    {
      name:"Parade on Cleveland (Young Thug ft. Drake)",
      src:"music/parade_on_cleveland.mp3",
      cover:"covers/parade.jpg",
      lyrics:[
        {time:0,text:"Whoa"},
        {time:3,text:"How the fuck you out here goin' tit-for-tat?"}
      ]
    }
  ],
  "Chill Vibes": [
    {name:"Song A",src:"music/songA.mp3",cover:"covers/songA.jpg",lyrics:[]},
    {name:"Song B",src:"music/songB.mp3",cover:"covers/songB.jpg",lyrics:[]}
  ]
};

let songs = playlists["Raghib's Playlist"];
let currentSong = 0;
let currentPage = 'home';

// ================= ELEMENTS =================
const audio = document.getElementById("audio");
const cover = document.getElementById("cover");
const songName = document.getElementById("songName");
const lyricsDiv = document.getElementById("lyrics");
const pageTitle = document.getElementById("pageTitle");
const songControls = document.getElementById("songControls");
const miniBar = document.getElementById("miniBar");
const miniCover = document.getElementById("miniCover");
const miniSongName = document.getElementById("miniSongName");
const progressFill = document.getElementById("progressFill");

// ================= LOAD SONG =================
function loadSong(index){
  const song = songs[index];
  audio.src = song.src;
  cover.style.backgroundImage = `url('${song.cover}')`;
  songName.textContent = song.name;
  miniCover.style.backgroundImage = `url('${song.cover}')`;
  miniSongName.textContent = song.name;
  document.body.style.setProperty("--bg-image",`url('${song.cover}')`);

  if(currentPage === 'home'){
    lyricsDiv.innerHTML = "";
    song.lyrics.forEach(line=>{
      const span = document.createElement("span");
      span.textContent = line.text;
      span.dataset.time = line.time;
      lyricsDiv.appendChild(span);
    });
  }
}

// ================= CONTROLS =================
function togglePlay(){ audio.paused ? audio.play() : audio.pause(); }
function nextSong(){ currentSong=(currentSong+1)%songs.length; loadSong(currentSong); audio.play(); }
function prevSong(){ currentSong=(currentSong-1+songs.length)%songs.length; loadSong(currentSong); audio.play(); }

// ================= PROGRESS =================
audio.addEventListener("timeupdate",()=>{
  const progress = (audio.currentTime / audio.duration) * 100;
  progressFill.style.width = isNaN(progress) ? "0%" : progress + "%";
});

// ================= QUEUE DRAG =================
let dragSrcIndex=null;

function renderQueue(){
  lyricsDiv.innerHTML="";
  songs.forEach((s,i)=>{
    const span=document.createElement("span");
    span.textContent=(i===currentSong?'âž¡ ':'')+s.name;
    span.dataset.index=i;
    span.draggable=true;
    span.ondragstart=()=>dragSrcIndex=i;
    span.ondragover=e=>e.preventDefault();
    span.ondrop=()=>{
      const moved=songs.splice(dragSrcIndex,1)[0];
      songs.splice(i,0,moved);
      renderQueue();
    };
    lyricsDiv.appendChild(span);
  });
}

// ================= PLAYLIST PAGES =================
function showPlaylists(){
  lyricsDiv.innerHTML="";
  Object.keys(playlists).forEach(name=>{
    const span=document.createElement("span");
    span.textContent=name;
    span.onclick=()=>showPlaylistSongs(name);
    lyricsDiv.appendChild(span);
  });
}

function showPlaylistSongs(name){
  songs = playlists[name];
  currentSong = 0;
  lyricsDiv.innerHTML="";
  songs.forEach((s,i)=>{
    const span=document.createElement("span");
    span.textContent=s.name;
    span.onclick=()=>{loadSong(i);audio.play();switchPage('home');};
    lyricsDiv.appendChild(span);
  });
}

// ================= PAGE SWITCH =================
function switchPage(page){
  if(secretActive) return; // LOCK UI IN SECRET MODE
  currentPage = page;

  if(page==='home'){
    pageTitle.textContent="ðŸ¤¬ Censored Music";
    cover.style.display="block";
    songName.style.display="block";
    songControls.style.display="flex";
    loadSong(currentSong);
    miniBar.classList.remove("visible");
  }

  if(page==='album'){
    pageTitle.textContent="ðŸ’¿ Playlist";
    songControls.style.display="none";
    showPlaylists();
    miniBar.classList.add("visible");
  }

  if(page==='queue'){
    pageTitle.textContent="ðŸŽµ Queue";
    cover.style.display="none";
    songName.style.display="none";
    songControls.style.display="none";
    renderQueue();
    miniBar.classList.add("visible");
  }
}

// ================= SECRET KEYPAD =================
document.addEventListener("keydown",e=>{
  const key=e.key.toLowerCase();
  keySequence+=key;

  if(keySequence.endsWith("secret")){
    secretActive=!secretActive;
    keySequence="";
    typedKeys="";
    secretActive ? activateSecretKeypad() : deactivateSecretKeypad();
  }

  if(secretActive && !isNaN(key)){
    typedKeys+=key;
    updateKeypadDisplay(typedKeys);
    if(typedKeys===expectedCode){
      document.getElementById("keypadDisplay").textContent="ðŸŽ‰ Secret Unlocked ðŸŽ‰";
      typedKeys="";
    }
  }
});

function activateSecretKeypad(){
  cover.style.display="none";
  songName.style.display="none";
  songControls.style.display="none";
  lyricsDiv.innerHTML=`<div id="keypadDisplay" style="font-size:2rem;text-align:center;">Enter code</div>`;
}

function deactivateSecretKeypad(){
  loadSong(currentSong);
  switchPage("home");
}

function updateKeypadDisplay(v){
  const d=document.getElementById("keypadDisplay");
  if(d) d.textContent=v||"Enter code";
}

// ================= INIT =================
loadSong(currentSong);
switchPage("home");
</script>
